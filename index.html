<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Check-in Cliente</title>
</head>
<body>
  <h2>Dados do Check-in</h2>

  <input id="vendedor" placeholder="Vendedor" /><br><br>
  <input id="id_cliente" placeholder="ID do Cliente" /><br><br>

  <button onclick="checkin()">Fazer Check-in</button>

  <script>
    function checkin() {
      // 1. Verifica se os campos estão preenchidos antes de pedir o GPS
      const vendedor = document.getElementById("vendedor").value;
      const id_cliente = document.getElementById("id_cliente").value;

      if (!vendedor || !id_cliente) {
        alert("Por favor, preencha o vendedor e o ID do cliente.");
        return;
      }

      if (!navigator.geolocation) {
        alert("Geolocalização não suportada pelo seu navegador.");
        return;
      }

      // 2. Solicita a posição
      navigator.geolocation.getCurrentPosition(
        position => {
          // Lógica para data e hora (UTC-3)
          const agora = new Date();
          const dataSP = agora.toLocaleDateString('sv-SE', { timeZone: 'America/Sao_Paulo' });
          const horaSP = agora.toLocaleTimeString('pt-BR', { timeZone: 'America/Sao_Paulo', hour12: false });

          const payload = {
            vendedor: vendedor,
            id_cliente: id_cliente,
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            data: dataSP,
            horario: horaSP,
            origem: "WEB_GPS"
          };

          // 3. Envio para o n8n
          fetch("https://andresalvi.app.n8n.cloud/webhook-test/check-in", { // <-- Use /webhook-test/ para testar!
            method: "POST",
            headers: { 
              "Content-Type": "application/json" 
            },
            body: JSON.stringify(payload)
          })
          .then(async response => {
            if (response.ok) {
              alert("Check-in enviado com sucesso!");
            } else {
              const textoErro = await response.text();
              console.error("Erro do n8n:", textoErro);
              alert("O n8n recebeu, mas retornou erro: " + response.status);
            }
          })
          .catch(err => {
            console.error("Erro de Rede/CORS:", err);
            alert("Erro ao conectar com o n8n. Verifique o console (F12).");
          });
        },
        err => {
          const mensagens = {
            1: "Permissão de localização negada pelo usuário.",
            2: "Posição indisponível.",
            3: "Tempo esgotado ao obter localização."
          };
          alert("Erro GPS: " + (mensagens[err.code] || err.message));
        },
        { 
          enableHighAccuracy: true, 
          timeout: 10000 // 10 segundos de limite
        }
      );
    }
</script>
</body>
</html>
